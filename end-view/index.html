<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>Title</title>
    <link rel="stylesheet" href="bower_components/Swiper/dist/css/swiper.css">


    <!-- Demo styles -->
    <style>
        html, body {
            position: relative;
            height: 100%;
        }
        body {
            background: #ffffff;
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 14px;
            color:#000;
            margin: 0;
            padding: 0;
        }
        .swiper-container {
            width: 100%;
            height: 100%;
        }
        .swiper-slide {

            transform-origin: bottom center;

            /*text-align: center;
            font-size: 18px;*/

            /*fixme background for debug*/
            /*background: #e6ee9c;*/

            /* Center slide text vertically */
            /*display: -webkit-box;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-align: center;
            -ms-flex-align: center;
            -webkit-align-items: center;
            align-items: center;*/
        }

        #top-canvas {
            height: 500px;
            width: 100%;
            /*#figure-container aligned to the bottom of #top-canvas */
            position: relative;
            background: #eee;
        }

        #figure-container {
            height: 50%;
            width: 100%;
            /*#figure-container aligned to the bottom of #top-canvas */
            position: absolute;
            bottom: 0;
        }

        .avatar-show {
            width: 100%;
            position: absolute;
            bottom: 0;
        }
    </style>
</head>
<body>

    <div id="top-canvas">
        <div id="parallax-bg">

        </div>

        <div id="figure-container">
            <!-- Swiper -->
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_43.png">
                    </div>
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_52.png">
                    </div>
                    <div id="test1" class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_47.png">
                    </div>
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_50.png">
                    </div>
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_52.png">
                    </div>
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_43.png">
                    </div>
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_47.png">
                    </div>
                    <div class="swiper-slide">
                        <img class="avatar-show" src="asset/q-avatar/sliced_50.png">
                    </div>
                    <div class="swiper-slide">Slide 10</div>
                </div>
                <!-- Add Pagination -->
                <div class="swiper-pagination"></div>
            </div>
        </div>

    </div>


    <!-- Swiper JS -->
    <script src="js/swiper-custom.js"></script>
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/Swiper/dist/js/swiper.jquery.js"></script>
    <script src="bower_components/tether/dist/js/tether.js"></script>
    <script src="bower_components/velocity/velocity.js"></script>
    <script src="js/bezier-easing.bundle.js"></script>

    <!-- Initialize Swiper -->
    <script>

        /*$('.swiper-wrapper').each(function(index) {
            new Tether({
                element: $(this, '.avatar-show'),
                target: this,
                attachment: 'bottom middle',
                targetAttachment: 'bottom middle'
            });
        });*/

        // wenop: rewrite when resize
        var sizeOfInnerImg = 0;

        function refreshSizeOfInnerImg(){
            //var h=$('.avatar-show').height();
            var h=$('.swiper-slide').css('width');
            h = parseInt(h, 10);
            sizeOfInnerImg = h?h:30;
            console.log('refreshSizeOfInnerImg,', sizeOfInnerImg);
        }
        //rewrite when resize
        $(window).resize(function(){
            refreshSizeOfInnerImg();
        });

        refreshSizeOfInnerImg();
        var wEasing = BezierEasing(0, 0, 1, 0.5);

        var hasInit=false;

        var staticFigureHalfProgressWidth = 1;

        var swiper = new Swiper('.swiper-container', {
            pagination: '.swiper-pagination',
            slidesPerView: 7,
            paginationClickable: true,
            spaceBetween: -10,
            /*set the active slide the centre one*/
            centeredSlides: true,

            breakpoints: {
                640: {
                    slidesPerView: 7,
                    spaceBetween: -30
                },
                320: {
                    slidesPerView: 5,
                    spaceBetween: -20
                }
            },

            onInit: function(swiper){
                refreshSizeOfInnerImg();
                refreshFigureHalfProgressWidth(swiper);
                hasInit = true;
            },

            onTransitionStart: function(swiper){
                console.log('onTransitionStart, NowActiveI='+ swiper.activeIndex);
                if (hasInit) {

                }
            },
            onTransitionEnd: function(swiper){
                console.log('onTransitionEnd, NowActiveI='+ swiper.activeIndex);
                // wenop: on transition end, detail animation
                if (hasInit) {
                    /*$('.swiper-slide-active').velocity({
                        scale:2
                    },{
                        duration: 3000
                    });*/
                }
            },
            onProgress: function(swiper, progress){
                if (hasInit) {
                    /*get centre slide index*/
                    var currentCentredIndex = Math.floor((progress+staticFigureHalfProgressWidth) / staticFigureHalfProgressWidth / 2);
//                    console.log(currentCentredIndex);
                    var slideN;

                    var offset_amount = interp_figure_offset(currentCentredIndex, progress);
                    var scale;
//                    fixme the const 4
                    for(slideN=currentCentredIndex-4; slideN<currentCentredIndex; slideN++) {
                        // offset left
                        if(swiper.slides[slideN]) {
                            scale = interp_figure_scale(slideN, progress);
                            $(swiper.slides[slideN]).css('transform',
                                    'scale('+scale+','+scale+')'
                                    + 'translateX(-'+offset_amount+'px)');
                        }
                    }

                    for(slideN=currentCentredIndex+4; slideN>currentCentredIndex; slideN--) {
                        // offset right
                        if(swiper.slides[slideN]) {
                            scale = interp_figure_scale(slideN, progress);
                            $(swiper.slides[slideN]).css('transform',
                                    'scale('+scale+','+scale+')'
                                    + ' translateX('+offset_amount+'px)');
                        }
                    }

                    scale = interp_figure_scale(currentCentredIndex, progress);
                    // scale for the centred one
                    $(swiper.slides[currentCentredIndex]).css('transform',
                            'scale('+scale+','+scale+')'
                           );

                    /*for(slideN=0; slideN<swiper.slides.length; slideN++) {
                        var s = interp_figure_scale(slideN, progress);
                        //console.log('onProgress,p='+ progress + ' ,s='+ s + ',activeI='+ swiper.activeIndex+', translate='+swiper.translate);

                        /!*wenop: scale the centred figure*!/
                        $(swiper.slides[slideN]).css('transform', 'scale('+s+','+s+')');
                    }*/
                }
            }
        });


        function refreshFigureHalfProgressWidth(swiper) {
            if (swiper.slides.length>1) {
                staticFigureHalfProgressWidth = (1.0 / (swiper.slides.length - 1)) / 2;
            } else {
                staticFigureHalfProgressWidth = 1;
            }
        }

        /* wenop: 对于第slideN个slide, 给定一个progress值，返回scale级数, range[1, 2] */
        function interp_figure_scale(slideN, progress) {
//            fixme: Optimize the calc here
            return wInterp((progress - (slideN * 2 * staticFigureHalfProgressWidth)) / staticFigureHalfProgressWidth)
        }

        /* wenop: 对于第slideN个slide, 给定一个progress值，返回左右应该额外空开的距离, range[0, sizeOfInnerImg/2] */
        function interp_figure_offset(slideN, progress) {
//            fixme: Optimize the calc here
            return (wInterp(
                    (progress - (slideN * 2 * staticFigureHalfProgressWidth)) / staticFigureHalfProgressWidth
                    ) - 1 ) * (sizeOfInnerImg/2)
        }

        function wInterp(i) {
            var ret;
            if (i<=-1) {
                ret = 1;
            } else if(i>-1 && i<0) {
                ret = wEasing.get(i+1) + 1;
            } else if(i>=0 && i<1) {
                ret = wEasing.get(1-i) + 1;
            } else {
                ret = 1;
            }
            return ret;
        }


/*        $('#test1').velocity({
            scale:2,
            translateY: '-62px'
        },{
            duration: 3000
        });

        $('#test1').velocity('reverse')*/



    </script>
</body>
</html>